{{- define "nova.register.podCommands" -}}
command:
  - /bin/sh
  - -c
  - |
    /tmp/ks-register-services.sh
    /tmp/ks-register-users.sh

{{- end }}

{{- define "nova.register.podEnvVars" -}}
{{- $envAll := index . 0 -}}
env:
  - name: SERVICE_NAME
    value: nova
  - name: SERVICE_TYPE
    value: compute
  - name: API_VERSION
    value: "v2.1"
  - name: ADMIN_URL
    valueFrom:
      secretKeyRef:
        key: NOVA_ADMIN_ENDPOINT
        name: {{ $envAll.Values.openstackDepRelease | quote }}
  - name: INTERNAL_URL
    valueFrom:
      secretKeyRef:
        key: NOVA_INTERNAL_ENDPOINT
        name: {{ $envAll.Values.openstackDepRelease | quote }}
  - name: USER_NAME
    value: nova
  - name: USER_PASSWORD
    valueFrom:
      secretKeyRef:
        key: nova-keystone-password
        name: {{ $envAll.Values.passwordRelease | quote }}
  - name: INGRESS_URI
    valueFrom:
      secretKeyRef:
        key: INGRESS_URI
        name: {{ $envAll.Values.openstackDepRelease | quote }}
{{- end }}

{{- define "nova.register.podVolMounts" -}}
volumeMounts:
  - name: nova-bin
    mountPath: /tmp/ks-register-services.sh
    subPath: ks-register-services.sh
  - name: nova-bin
    mountPath: /tmp/ks-register-users.sh
    subPath: ks-register-users.sh
{{- end }}

{{- $envAll := index . -}}
{{- $podCommands := tuple . | include "nova.register.podCommands" | toString | fromYaml }}
{{- $podEnvVars := tuple . | include "nova.register.podEnvVars" | toString | fromYaml }}
{{- $podVolMounts := tuple . | include "nova.register.podVolMounts" | toString | fromYaml }}
{{- $dependencySvcs := list "keystone-api" -}}
{{- $registerJob := dict "envAll" . "serviceName" "nova" "dependencySvcs" $dependencySvcs "podCommands" $podCommands.command "podEnvVars" $podEnvVars.env "podVolMounts" $podVolMounts.volumeMounts -}}
{{ $registerJob | include "common.manifests.job_register" }}
